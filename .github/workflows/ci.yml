name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  format:
    name: clang-format
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-18
          sudo ln -sf /usr/bin/clang-format-18 /usr/local/bin/clang-format

      - name: Check formatting
        run: |
          ./scripts/check-format.sh
          git diff --exit-code

  build-linux:
    name: Linux ${{ matrix.compiler }} / ${{ matrix.config }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - compiler: gcc-12
            cc: gcc-12
            cxx: g++-12
            pkg: g++-12
          - compiler: gcc-14
            cc: gcc-14
            cxx: g++-14
            pkg: g++-14
          - compiler: clang-16
            cc: clang-16
            cxx: clang++-16
            pkg: clang-16
          - compiler: clang-18
            cc: clang-18
            cxx: clang++-18
            pkg: clang-18
        config:
          - Release
          - RelWithDebInfo
    env:
      CC: ${{ matrix.cc }}
      CXX: ${{ matrix.cxx }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build ${{ matrix.pkg }}

      - name: Configure
        run: |
          cmake -G "Ninja Multi-Config" -B build \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DCMAKE_CXX_FLAGS="-Wall -Wextra -pedantic -Werror" \
            -DCMAKE_CXX_FLAGS_RELEASE="-g -DNDEBUG -O3" \
            -DCMAKE_CXX_FLAGS_RELWITHDEBINFO="-fsanitize=undefined -fsanitize=address -g -O3" \
            -DCMAKE_C_FLAGS_RELWITHDEBINFO="-fsanitize=undefined -fsanitize=address -g -O3" \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -Dnlohmann_json_GIT_TAG=v3.10.0 \
            -Dnlohmann_json_FORCE_DOWNLOAD=ON \
            -Dnlohmann_json_schema_validator_FORCE_DOWNLOAD=ON \
            -Dnlohmann_json_schema_validator_GIT_TAG=2.4.0 \
            -DJSON_VALIDATOR_BUILD_TESTS=OFF \
            -DJSON_VALIDATOR_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build --config ${{ matrix.config }}

      - name: Test
        run: ctest --test-dir build -C ${{ matrix.config }} --output-on-failure

  build-macos:
    name: macOS apple-clang / ${{ matrix.config }}
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        config:
          - Release
          - RelWithDebInfo
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Ninja
        run: brew install ninja

      - name: Configure
        run: |
          cmake -G "Ninja Multi-Config" -B build \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DCMAKE_CXX_FLAGS="-Wall -Wextra -pedantic -Werror" \
            -DCMAKE_CXX_FLAGS_RELEASE="-g -DNDEBUG -O3" \
            -DCMAKE_CXX_FLAGS_RELWITHDEBINFO="-fsanitize=undefined -fsanitize=address -g -O3" \
            -DCMAKE_C_FLAGS_RELWITHDEBINFO="-fsanitize=undefined -fsanitize=address -g -O3" \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -Dnlohmann_json_GIT_TAG=v3.10.0 \
            -Dnlohmann_json_FORCE_DOWNLOAD=ON \
            -Dnlohmann_json_schema_validator_FORCE_DOWNLOAD=ON \
            -Dnlohmann_json_schema_validator_GIT_TAG=2.4.0 \
            -DJSON_VALIDATOR_BUILD_TESTS=OFF \
            -DJSON_VALIDATOR_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build --config ${{ matrix.config }}

      - name: Test
        run: ctest --test-dir build -C ${{ matrix.config }} --output-on-failure
